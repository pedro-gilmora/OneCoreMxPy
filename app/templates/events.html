{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="bi bi-clock-history text-primary me-2"></i>
            Histórico de Eventos
        </h2>
        <p class="text-muted mb-0">Registro de todas las actividades del sistema</p>
    </div>
    <button class="btn btn-success" onclick="exportToExcel()">
        <i class="bi bi-file-earmark-excel me-2"></i>
        Exportar a Excel
    </button>
</div>

<!-- Statistics -->
<div class="row mb-4" id="eventStats">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 opacity-75">Total Eventos</h6>
                    <h3 class="mb-0" id="totalEvents">0</h3>
                </div>
                <i class="bi bi-journal-text stats-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 opacity-75">Subidas</h6>
                    <h3 class="mb-0" id="uploadEvents">0</h3>
                </div>
                <i class="bi bi-cloud-upload stats-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 opacity-75">Análisis IA</h6>
                    <h3 class="mb-0" id="aiEvents">0</h3>
                </div>
                <i class="bi bi-robot stats-icon"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 opacity-75">Interacciones</h6>
                    <h3 class="mb-0" id="userEvents">0</h3>
                </div>
                <i class="bi bi-person-check stats-icon"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body py-3">
        <form id="filterForm" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label small text-muted" for="eventTypeFilter">Tipo de Evento</label>
                <select class="form-select" id="eventTypeFilter" aria-label="Filtrar por tipo de evento">
                    <option value="">Todos los tipos</option>
                    <option value="subida_documento">Subida de Documento</option>
                    <option value="analisis_ia">Análisis IA</option>
                    <option value="interaccion_usuario">Interacción Usuario</option>
                    <option value="sistema">Sistema</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted" for="searchFilter">Buscar</label>
                <input type="text" class="form-control" id="searchFilter" 
                       placeholder="Buscar en descripción..." aria-label="Buscar en descripción">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted" for="dateFrom">Desde</label>
                <input type="date" class="form-control" id="dateFrom" aria-label="Fecha desde">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted" for="dateTo">Hasta</label>
                <input type="date" class="form-control" id="dateTo" aria-label="Fecha hasta">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>
                    Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Events Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list-ul me-2"></i>Eventos</span>
        <div>
            <span class="badge bg-secondary me-2" id="eventsCount">0 eventos</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadEvents()" title="Actualizar">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th style="width: 180px;">Tipo</th>
                        <th>Descripción</th>
                        <th style="width: 120px;">Usuario</th>
                        <th style="width: 180px;">Fecha y Hora</th>
                        <th style="width: 80px;" class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="eventsTable">
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox empty-icon"></i>
                            <p class="mt-2">No hay eventos registrados</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <nav aria-label="Paginación de eventos">
            <ul class="pagination pagination-sm justify-content-center mb-0" id="pagination">
                <!-- Pagination will be rendered here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailModalLabel">
                    <i class="bi bi-info-circle me-2"></i>
                    Detalle del Evento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="eventDetailBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .stats-icon {
        font-size: 2rem;
        opacity: 0.5;
    }
    
    .empty-icon {
        font-size: 3rem;
    }
    
    .event-type-badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }
    
    .event-type-upload {
        background-color: #198754;
    }
    
    .event-type-ai {
        background-color: #0dcaf0;
        color: #000;
    }
    
    .event-type-user {
        background-color: #ffc107;
        color: #000;
    }
    
    .event-type-system {
        background-color: #6c757d;
    }
    
    .metadata-json {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        font-family: monospace;
        font-size: 0.85rem;
        max-height: 200px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    const pageSize = 20;
    let totalEvents = 0;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadEvents();
        loadStats();
        
        // Setup filter form
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            currentPage = 1;
            loadEvents();
        });
    });
    
    // Load events
    async function loadEvents() {
        const eventType = document.getElementById('eventTypeFilter').value;
        const search = document.getElementById('searchFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        let url = `/events/?page=${currentPage}&page_size=${pageSize}`;
        
        if (eventType) url += `&event_type=${eventType}`;
        if (search) url += `&description_search=${encodeURIComponent(search)}`;
        if (dateFrom) url += `&date_from=${dateFrom}T00:00:00`;
        if (dateTo) url += `&date_to=${dateTo}T23:59:59`;
        
        try {
            const response = await apiRequest(url);
            
            if (response.ok) {
                const data = await response.json();
                totalEvents = data.total;
                renderEvents(data.events);
                renderPagination(data.total);
                document.getElementById('eventsCount').textContent = `${data.total} eventos`;
            }
        } catch (error) {
            showToast('Error al cargar eventos', 'error');
        }
    }
    
    // Load statistics
    async function loadStats() {
        try {
            const response = await apiRequest('/events/stats');
            
            if (response.ok) {
                const stats = await response.json();
                
                document.getElementById('totalEvents').textContent = stats.total;
                document.getElementById('uploadEvents').textContent = stats.by_type['Subida de Documento'] || 0;
                document.getElementById('aiEvents').textContent = stats.by_type['Análisis IA'] || 0;
                document.getElementById('userEvents').textContent = stats.by_type['Interacción de Usuario'] || 0;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    // Render events table
    function renderEvents(events) {
        const tbody = document.getElementById('eventsTable');
        
        if (events.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox empty-icon"></i>
                        <p class="mt-2">No hay eventos que mostrar</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = events.map(event => {
            const typeBadge = getEventTypeBadge(event.event_type);
            
            return `
                <tr>
                    <td><code>#${event.id}</code></td>
                    <td>${typeBadge}</td>
                    <td class="text-truncate" style="max-width: 300px;" title="${event.description}">
                        ${event.description}
                    </td>
                    <td>
                        ${event.username ? `<i class="bi bi-person me-1"></i>${event.username}` : '<span class="text-muted">-</span>'}
                    </td>
                    <td><small>${formatDate(event.created_at)}</small></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary btn-action" 
                                onclick="viewEventDetail(${event.id})" 
                                title="Ver detalle">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Get event type badge HTML
    function getEventTypeBadge(eventType) {
        const badges = {
            'subida_documento': '<span class="badge event-type-badge event-type-upload"><i class="bi bi-cloud-upload me-1"></i>Subida</span>',
            'analisis_ia': '<span class="badge event-type-badge event-type-ai"><i class="bi bi-robot me-1"></i>IA</span>',
            'interaccion_usuario': '<span class="badge event-type-badge event-type-user"><i class="bi bi-person me-1"></i>Usuario</span>',
            'sistema': '<span class="badge event-type-badge event-type-system"><i class="bi bi-gear me-1"></i>Sistema</span>'
        };
        return badges[eventType] || `<span class="badge bg-secondary">${eventType}</span>`;
    }
    
    // Render pagination
    function renderPagination(total) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let html = '';
        
        // Previous button
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})" aria-label="Anterior">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        `;
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1)">1</a></li>`;
            if (startPage > 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>
            `;
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages})">${totalPages}</a></li>`;
        }
        
        // Next button
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})" aria-label="Siguiente">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;
        
        pagination.innerHTML = html;
    }
    
    // Go to specific page
    function goToPage(page) {
        const totalPages = Math.ceil(totalEvents / pageSize);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        loadEvents();
    }
    
    // View event detail
    async function viewEventDetail(eventId) {
        showLoading();
        
        try {
            const response = await apiRequest(`/events/${eventId}`);
            
            if (response.ok) {
                const event = await response.json();
                renderEventDetail(event);
                
                const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
                modal.show();
            }
        } catch (error) {
            showToast('Error al cargar detalle del evento', 'error');
        } finally {
            hideLoading();
        }
    }
    
    // Render event detail
    function renderEventDetail(event) {
        const body = document.getElementById('eventDetailBody');
        
        const eventTypeLabels = {
            'subida_documento': 'Subida de Documento',
            'analisis_ia': 'Análisis IA',
            'interaccion_usuario': 'Interacción de Usuario',
            'sistema': 'Sistema'
        };
        
        let metadataHtml = '';
        if (event.metadata) {
            metadataHtml = `
                <div class="mt-3">
                    <strong>Metadatos:</strong>
                    <div class="metadata-json mt-2">
                        <pre class="mb-0">${JSON.stringify(event.metadata, null, 2)}</pre>
                    </div>
                </div>
            `;
        }
        
        body.innerHTML = `
            <table class="table table-sm">
                <tr>
                    <th style="width: 120px;">ID:</th>
                    <td><code>#${event.id}</code></td>
                </tr>
                <tr>
                    <th>Tipo:</th>
                    <td>${getEventTypeBadge(event.event_type)}</td>
                </tr>
                <tr>
                    <th>Descripción:</th>
                    <td>${event.description}</td>
                </tr>
                <tr>
                    <th>Usuario:</th>
                    <td>${event.username || '<span class="text-muted">N/A</span>'}</td>
                </tr>
                ${event.document_id ? `
                <tr>
                    <th>Documento:</th>
                    <td><a href="#" onclick="viewDocument(${event.document_id})">#${event.document_id}</a></td>
                </tr>
                ` : ''}
                <tr>
                    <th>Fecha:</th>
                    <td>${formatDate(event.created_at)}</td>
                </tr>
            </table>
            ${metadataHtml}
        `;
    }
    
    // View related document
    function viewDocument(docId) {
        bootstrap.Modal.getInstance(document.getElementById('eventDetailModal')).hide();
        window.location.href = `/web/documents?highlight=${docId}`;
    }
    
    // Export to Excel
    async function exportToExcel() {
        const eventType = document.getElementById('eventTypeFilter').value;
        const search = document.getElementById('searchFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        let url = `${API_BASE}/events/export?`;
        const params = new URLSearchParams();
        
        if (eventType) params.append('event_type', eventType);
        if (search) params.append('description_search', search);
        if (dateFrom) params.append('date_from', `${dateFrom}T00:00:00`);
        if (dateTo) params.append('date_to', `${dateTo}T23:59:59`);
        
        showLoading();
        
        try {
            const response = await fetch(url + params.toString(), {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `historico_eventos_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                showToast('Archivo Excel descargado', 'success');
            } else if (response.status === 403) {
                showToast('Se requiere rol de administrador para exportar', 'error');
            } else {
                throw new Error('Error al exportar');
            }
        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            hideLoading();
        }
    }
</script>
{% endblock %}
